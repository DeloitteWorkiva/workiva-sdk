# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Workiva Multi-API Python SDK — 3 independent OpenAPI specs (platform, chains, wdata) merged into a single unified Python SDK generated by Speakeasy. Output lives in `python-sdk/`.

## Commands

```bash
# Full pipeline (download specs → check changes → prepare → merge → generate → patch)
make all

# Force regeneration (bypass change detection)
make force

# Individual pipeline steps
make prepare        # Pre-process specs (rename conflicts, add pagination, fix recursion)
make merge          # Speakeasy merge into merged.yaml
make generate       # Speakeasy generate + patch_sdk.py + save checksums

# Testing
make test           # All 58 tests (unit + integration)
make test-unit      # Unit tests only
make test-integration  # Integration tests only
make test-cov       # Coverage report for workiva._hooks

# Run a single test
cd python-sdk && uv run pytest tests/unit/test_polling_helpers.py::TestExtractOperationId::test_full_url -v

# Build wheel
make build          # → python-sdk/dist/workiva-0.4.0-py3-none-any.whl

# Dependency management
cd python-sdk && uv sync   # Install/sync all deps including dev
```

## Architecture

### Pipeline: Spec → SDK

```
platform.yaml ─┐                                    ┌─ python-sdk/src/workiva/
chains.yaml   ─┤→ prepare_specs.py → *_processed.yaml → speakeasy merge → merged.yaml → speakeasy generate ─┤
wdata.yaml    ─┘                                    └─ patch_sdk.py (exports + README)
```

**`scripts/prepare_specs.py`** handles what Speakeasy can't:
- Schema name collisions (Activity, Permission, User, Workspace, SingleError) — renamed with `Chain` prefix
- OperationId collisions — prefixed per API (`chains_*`, `wdata_*`) + `x-speakeasy-name-override` preserves clean method names
- Recursive schemas (Section.parent, Slide.parent, Sheet.parent self-reference via allOf) — broken with inline objects
- Path-level `servers` injection for multi-base-URL routing
- `x-speakeasy-group` for SDK namespaces (`sdk.chains.*`, `sdk.wdata.*`)
- Pagination extensions for 89 operations across 5 patterns

**`scripts/patch_sdk.py`** runs after generation (idempotent):
- Appends custom exports to `__init__.py` (Workiva, OperationPoller, exceptions)
- Cleans README.md (removes Speakeasy scaffolding, adds real install instructions)

### Generated vs Custom Code

**Everything in `python-sdk/src/workiva/` is regenerated by `make force` EXCEPT `_hooks/`.**

Custom code (survives regeneration):
- `_hooks/client.py` — `Workiva(SDK)` convenience wrapper with `.wait()` for 202 responses
- `_hooks/polling.py` — `OperationPoller` with sync/async polling, retry-after, timeout
- `_hooks/exceptions.py` — `OperationFailed`, `OperationCancelled`, `OperationTimeout`
- `_hooks/registration.py` — Hook extension point (generated once, then free to modify)

Generated hooks (overwritten on regeneration):
- `_hooks/clientcredentials.py` — OAuth2 client_credentials flow
- `_hooks/sdkhooks.py` — Hook orchestration
- `_hooks/types.py` — Hook interfaces

### Auth

All 3 APIs share the same bearer token from `/iam/v1/oauth2/token`. The `ClientCredentialsHook` handles this automatically — it caches tokens in a **class-level dict** (`ClassVar`), meaning the cache is global across all SDK instances in a process. The hook always uses a **sync** HTTP client for token requests, even in async flows (runs in a thread via `asyncio.to_thread`).

### SDK Usage Pattern

```python
from workiva import Workiva

with Workiva(client_id="...", client_secret="...") as client:
    # Regular API call
    response = client.files.copy_file(file_id="abc", file_copy=params)
    # Poll long-running operation
    operation = client.wait(response).result(timeout=300)
```

## Testing

Tests live in `python-sdk/tests/` (outside `src/`, safe from regeneration).

- **Unit tests** mock the SDK with `MagicMock`/`AsyncMock`
- **Integration tests** use `httpx.MockTransport` with stateful handlers for end-to-end HTTP simulation
- **Async integration tests** must provide BOTH sync client (for OAuth token hook) and async client (for API calls)
- **conftest.py** has an autouse fixture that clears `ClientCredentialsHook._sessions` and `_client_locks` between tests — without this, cached tokens leak between tests

### Key testing gotchas

- `OperationDetail()` default fields are `Unset()` instances — not `None`, not `UNSET_SENTINEL`. Check against `None` or `UNSET_SENTINEL` in code, but don't assume default-constructed models have those values.
- `[dependency-groups]` in pyproject.toml is what `uv sync` reads. `[tool.poetry.group.dev.dependencies]` is ignored by uv.

## Configuration

**`python-sdk/gen.yaml`** controls Speakeasy generation. Changes here propagate to regenerated `pyproject.toml`, `__init__.py`, etc.:
- `additionalDependencies` → pyproject.toml dependencies
- `authors` → pyproject.toml authors
- `asyncMode: both` → generates sync + async methods
- `asyncPaginationSep2025: true` → enables async pagination generators
- `allOfMergeStrategy: shallowMerge` → required for the merged spec

**Merge order matters**: platform.yaml is LAST in the merge command because the last spec's global `servers` win. Platform's servers (US/EU/APAC) should be the global default.

## File Survival Matrix

| Location | Survives `make force`? |
|----------|----------------------|
| `gen.yaml`, `scripts/`, `Makefile`, `tests/` | Yes |
| `_hooks/client.py`, `_hooks/polling.py`, `_hooks/exceptions.py` | Yes (Speakeasy preserves) |
| `_hooks/registration.py` | Yes (generated once) |
| `__init__.py`, `pyproject.toml`, `README.md` | Regenerated, then patched |
| Everything else in `src/workiva/` | Regenerated (do not modify) |
