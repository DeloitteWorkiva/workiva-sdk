# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Workiva Multi-API Python SDK — 3 independent OpenAPI specs (platform, chains, wdata) merged into a single unified Python SDK generated by Speakeasy. Output lives in `workiva-sdk/`.

## Commands

```bash
# Full pipeline (download specs → check changes → prepare → merge → generate → patch)
make all

# Force regeneration (bypass change detection)
make force

# Individual pipeline steps
make prepare        # Pre-process specs (rename conflicts, add pagination, fix recursion)
make merge          # Speakeasy merge into merged.yaml
make generate       # Speakeasy generate + patch_sdk.py + save checksums

# Testing
make test           # All tests (unit + integration)
make test-unit      # Unit tests only
make test-integration  # Integration tests only
make test-cov       # Coverage report for workiva._hooks

# Run a single test
cd workiva-sdk && uv run pytest tests/unit/test_polling_helpers.py::TestExtractOperationId::test_full_url -v

# Build wheel
make build          # → workiva-sdk/dist/workiva-X.Y.Z-py3-none-any.whl

# Dependency management
cd workiva-sdk && uv sync   # Install/sync all deps including dev
```

## Architecture

### Pipeline: Spec → SDK

```
oas/platform.yaml ─┐                                    ┌─ workiva-sdk/src/workiva/
oas/chains.yaml   ─┤→ prepare_specs.py → *_processed.yaml → speakeasy merge → merged.yaml → speakeasy generate ─┤
oas/wdata.yaml    ─┘                                    └─ patch_sdk.py (exports + README)
```

**`scripts/prepare_specs.py`** handles what Speakeasy can't:
- Schema name collisions (Activity, Permission, User, Workspace, SingleError) — renamed with `Chain` prefix
- OperationId collisions — prefixed per API (`chains_*`, `wdata_*`) + `x-speakeasy-name-override` preserves clean method names
- Recursive schemas (Section.parent, Slide.parent, Sheet.parent self-reference via allOf) — broken with inline objects
- Path-level `servers` injection for multi-base-URL routing
- `x-speakeasy-group` for SDK namespaces (`sdk.chains.*`, `sdk.wdata.*`)
- Pagination extensions for 89 operations across 5 patterns

**`scripts/patch_sdk.py`** runs after generation (idempotent):
- Appends custom exports to `__init__.py` (Workiva, OperationPoller, exceptions)
- Cleans README.md (removes Speakeasy scaffolding, adds real install instructions)
- Injects `X-Version: 2026-01-01` header into `clientcredentials.py` token request
- Adds proprietary license, classifiers, and project URLs to `pyproject.toml`

**`scripts/detect_breaking_changes.py`** — AST-based comparison of old vs new model files:
- Parses all `.py` in models dir, extracts Enum classes (members + OpenEnumMeta) and BaseModel classes (fields + types + defaults)
- **Breaking** (exit 1): enum value removed, OpenEnumMeta lost, model/field removed, new required field, schema collision
- **Compatible** (exit 0): new model/enum/field/value added, type annotation changed
- Outputs markdown report for PR body; also writes `breaking_changes_report.md`
- Usage: `python scripts/detect_breaking_changes.py <old_models_dir> <new_models_dir> [oas_dir]`

**`scripts/bump_version.py`** — Atomic patch version bump across all 4 version files:
- Reads current version from `pyproject.toml`, increments patch (e.g. `0.5.7` → `0.5.8`)
- Validates all files contain the old version before writing any (fail-fast)
- Updates: `pyproject.toml`, `gen.yaml`, `_version.py` (`__version__` + `__user_agent__`), `README.md` badge
- Usage: `python scripts/bump_version.py` (prints new version to stdout)

**`scripts/smoke_test.py`** — Manual pre-release smoke test against live APIs:
- Verifies all 3 APIs (Platform, Wdata, Chains) respond with a valid token
- Reads credentials from `.env` (`WORKIVA_CLIENT_ID`, `WORKIVA_CLIENT_SECRET`)
- Usage: `cd workiva-sdk && uv run python ../scripts/smoke_test.py`

### Generated vs Custom Code

**Everything in `workiva-sdk/src/workiva/` is regenerated by `make force` EXCEPT `_hooks/`.**

Custom code (survives regeneration):
- `_hooks/client.py` — `Workiva(SDK)` convenience wrapper with `.wait()` for 202 responses
- `_hooks/polling.py` — `OperationPoller` with sync/async polling, retry-after, timeout
- `_hooks/exceptions.py` — `OperationFailed`, `OperationCancelled`, `OperationTimeout`
- `_hooks/version_header.py` — `VersionHeaderHook` injects `X-Version: 2026-01-01` on all API calls
- `_hooks/registration.py` — Hook extension point (generated once, then free to modify)

Generated hooks (overwritten on regeneration):
- `_hooks/clientcredentials.py` — OAuth2 client_credentials flow
- `_hooks/sdkhooks.py` — Hook orchestration
- `_hooks/types.py` — Hook interfaces

### Auth

All 3 APIs share the same bearer token from `/oauth2/token` (2026-01-01 API). The `ClientCredentialsHook` handles this automatically — it caches tokens in a **class-level dict** (`ClassVar`), meaning the cache is global across all SDK instances in a process. The hook always uses a **sync** HTTP client for token requests, even in async flows (runs in a thread via `asyncio.to_thread`). All requests include `X-Version: 2026-01-01` header (via `VersionHeaderHook` for API calls, and `patch_sdk.py` for token requests).

### SDK Usage Pattern

```python
from workiva import Workiva

with Workiva(client_id="...", client_secret="...") as client:
    # Regular API call
    response = client.files.copy_file(file_id="abc", file_copy=params)
    # Poll long-running operation
    operation = client.wait(response).result(timeout=300)
```

## Testing

Tests live in `workiva-sdk/tests/` (outside `src/`, safe from regeneration).

- **Unit tests** mock the SDK with `MagicMock`/`AsyncMock`
- **Integration tests** use `httpx.MockTransport` with stateful handlers for end-to-end HTTP simulation
- **Async integration tests** must provide BOTH sync client (for OAuth token hook) and async client (for API calls)
- **conftest.py** has an autouse fixture that clears `ClientCredentialsHook._sessions` and `_client_locks` between tests — without this, cached tokens leak between tests

### Key testing gotchas

- `OperationDetail()` default fields are `Unset()` instances — not `None`, not `UNSET_SENTINEL`. Check against `None` or `UNSET_SENTINEL` in code, but don't assume default-constructed models have those values.
- `[dependency-groups]` in pyproject.toml is what `uv sync` reads. `[tool.poetry.group.dev.dependencies]` is ignored by uv.

## Configuration

**`workiva-sdk/gen.yaml`** controls Speakeasy generation. Changes here propagate to regenerated `pyproject.toml`, `__init__.py`, etc.:
- `additionalDependencies` → pyproject.toml dependencies
- `authors` → pyproject.toml authors
- `asyncMode: both` → generates sync + async methods
- `asyncPaginationSep2025: true` → enables async pagination generators
- `allOfMergeStrategy: shallowMerge` → required for the merged spec

**Merge order matters**: platform.yaml is LAST in the merge command because the last spec's global `servers` win. Platform's servers (EU/US/APAC) are the global default — EU is index 0 (default). All specs live in `oas/`. The server order is set in `prepare_specs.py`.

## Publishing to PyPI

When changes affect the SDK source code (hooks, patches, or regeneration), a new version must be published to PyPI.

### Automated publish (OAS spec updates)

`check-specs.yml` runs every Monday and handles the full lifecycle:

```
download → changed? → snapshot models → regenerate → test
    → detect_breaking_changes.py
        ├─ exit 0 → bump_version.py → create PR → auto-merge → create release → publish.yml → PyPI
        └─ exit 1 → create PR with "breaking-change" label + report → STOP (manual review)
```

Auto-merge uses `AUTO_MERGE_TOKEN` (PAT with admin access) for `gh pr merge --admin`.

### Manual publish flow

For changes outside OAS updates (hooks, patches, scripts):

```bash
# 1. Bump version atomically across all 4 files
python scripts/bump_version.py  # prints new version

# 2. Run tests
make test

# 3. Commit and push
git add ... && git commit && git push

# 4. Create GitHub release (triggers CI publish)
gh release create vX.Y.Z --title "vX.Y.Z" --notes "Release notes here"
```

**CI handles the rest**: `.github/workflows/publish.yml` triggers on `release: [published]`,
runs tests, builds the wheel, and publishes to PyPI via `gh-action-pypi-publish` using
the `PYPI_API_TOKEN` secret in the `pypi` environment.

### What triggers a new version

- Changes to custom hooks (`_hooks/client.py`, `_hooks/polling.py`, `_hooks/exceptions.py`, `_hooks/version_header.py`, `_hooks/registration.py`)
- Changes to `patch_sdk.py` that affect generated output
- Changes to `prepare_specs.py` that affect the generated SDK (tokenUrl, servers, pagination, etc.)
- SDK regeneration after OAS spec updates (`make force`)

### Version files that must stay in sync

| File | Field | Role |
|------|-------|------|
| `workiva-sdk/gen.yaml` | `python.version` | Controls what Speakeasy writes to pyproject.toml on regeneration |
| `workiva-sdk/pyproject.toml` | `[project].version` | What `uv build` / `pip` reads |
| `workiva-sdk/src/workiva/_version.py` | `__version__` + `__user_agent__` | Runtime version (regenerated by Speakeasy, patch if needed) |
| `README.md` | Badge `?v=X.Y.Z` | Cache-buster for shields.io |

### PyPI credentials

- **CI**: `PYPI_API_TOKEN` as GitHub secret in the `pypi` environment
- **API token**: generate at https://pypi.org/manage/account/token/

## File Survival Matrix

| Location | Survives `make force`? |
|----------|----------------------|
| `oas/`, `gen.yaml`, `scripts/`, `Makefile`, `tests/` | Yes |
| `_hooks/client.py`, `_hooks/polling.py`, `_hooks/exceptions.py`, `_hooks/version_header.py` | Yes (Speakeasy preserves) |
| `_hooks/registration.py` | Yes (generated once) |
| `__init__.py`, `pyproject.toml`, `README.md` | Regenerated, then patched |
| Everything else in `src/workiva/` | Regenerated (do not modify) |
