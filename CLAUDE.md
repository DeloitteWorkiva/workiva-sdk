# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Workiva Multi-API Python SDK — 3 independent OpenAPI specs (platform, chains, wdata) merged into a single unified Python SDK generated by Speakeasy. Output lives in `python-sdk/`.

## Commands

```bash
# Full pipeline (download specs → check changes → prepare → merge → generate → patch)
make all

# Force regeneration (bypass change detection)
make force

# Individual pipeline steps
make prepare        # Pre-process specs (rename conflicts, add pagination, fix recursion)
make merge          # Speakeasy merge into merged.yaml
make generate       # Speakeasy generate + patch_sdk.py + save checksums

# Testing
make test           # All 58 tests (unit + integration)
make test-unit      # Unit tests only
make test-integration  # Integration tests only
make test-cov       # Coverage report for workiva._hooks

# Run a single test
cd python-sdk && uv run pytest tests/unit/test_polling_helpers.py::TestExtractOperationId::test_full_url -v

# Build wheel
make build          # → python-sdk/dist/workiva-0.4.0-py3-none-any.whl

# Dependency management
cd python-sdk && uv sync   # Install/sync all deps including dev
```

## Architecture

### Pipeline: Spec → SDK

```
oas/platform.yaml ─┐                                    ┌─ python-sdk/src/workiva/
oas/chains.yaml   ─┤→ prepare_specs.py → *_processed.yaml → speakeasy merge → merged.yaml → speakeasy generate ─┤
oas/wdata.yaml    ─┘                                    └─ patch_sdk.py (exports + README)
```

**`scripts/prepare_specs.py`** handles what Speakeasy can't:
- Schema name collisions (Activity, Permission, User, Workspace, SingleError) — renamed with `Chain` prefix
- OperationId collisions — prefixed per API (`chains_*`, `wdata_*`) + `x-speakeasy-name-override` preserves clean method names
- Recursive schemas (Section.parent, Slide.parent, Sheet.parent self-reference via allOf) — broken with inline objects
- Path-level `servers` injection for multi-base-URL routing
- `x-speakeasy-group` for SDK namespaces (`sdk.chains.*`, `sdk.wdata.*`)
- Pagination extensions for 89 operations across 5 patterns

**`scripts/patch_sdk.py`** runs after generation (idempotent):
- Appends custom exports to `__init__.py` (Workiva, OperationPoller, exceptions)
- Cleans README.md (removes Speakeasy scaffolding, adds real install instructions)
- Injects `X-Version: 2026-01-01` header into `clientcredentials.py` token request
- Adds proprietary license, classifiers, and project URLs to `pyproject.toml`

### Generated vs Custom Code

**Everything in `python-sdk/src/workiva/` is regenerated by `make force` EXCEPT `_hooks/`.**

Custom code (survives regeneration):
- `_hooks/client.py` — `Workiva(SDK)` convenience wrapper with `.wait()` for 202 responses
- `_hooks/polling.py` — `OperationPoller` with sync/async polling, retry-after, timeout
- `_hooks/exceptions.py` — `OperationFailed`, `OperationCancelled`, `OperationTimeout`
- `_hooks/version_header.py` — `VersionHeaderHook` injects `X-Version: 2026-01-01` on all API calls
- `_hooks/registration.py` — Hook extension point (generated once, then free to modify)

Generated hooks (overwritten on regeneration):
- `_hooks/clientcredentials.py` — OAuth2 client_credentials flow
- `_hooks/sdkhooks.py` — Hook orchestration
- `_hooks/types.py` — Hook interfaces

### Auth

All 3 APIs share the same bearer token from `/oauth2/token` (2026-01-01 API). The `ClientCredentialsHook` handles this automatically — it caches tokens in a **class-level dict** (`ClassVar`), meaning the cache is global across all SDK instances in a process. The hook always uses a **sync** HTTP client for token requests, even in async flows (runs in a thread via `asyncio.to_thread`). All requests include `X-Version: 2026-01-01` header (via `VersionHeaderHook` for API calls, and `patch_sdk.py` for token requests).

### SDK Usage Pattern

```python
from workiva import Workiva

with Workiva(client_id="...", client_secret="...") as client:
    # Regular API call
    response = client.files.copy_file(file_id="abc", file_copy=params)
    # Poll long-running operation
    operation = client.wait(response).result(timeout=300)
```

## Testing

Tests live in `python-sdk/tests/` (outside `src/`, safe from regeneration).

- **Unit tests** mock the SDK with `MagicMock`/`AsyncMock`
- **Integration tests** use `httpx.MockTransport` with stateful handlers for end-to-end HTTP simulation
- **Async integration tests** must provide BOTH sync client (for OAuth token hook) and async client (for API calls)
- **conftest.py** has an autouse fixture that clears `ClientCredentialsHook._sessions` and `_client_locks` between tests — without this, cached tokens leak between tests

### Key testing gotchas

- `OperationDetail()` default fields are `Unset()` instances — not `None`, not `UNSET_SENTINEL`. Check against `None` or `UNSET_SENTINEL` in code, but don't assume default-constructed models have those values.
- `[dependency-groups]` in pyproject.toml is what `uv sync` reads. `[tool.poetry.group.dev.dependencies]` is ignored by uv.

## Configuration

**`python-sdk/gen.yaml`** controls Speakeasy generation. Changes here propagate to regenerated `pyproject.toml`, `__init__.py`, etc.:
- `additionalDependencies` → pyproject.toml dependencies
- `authors` → pyproject.toml authors
- `asyncMode: both` → generates sync + async methods
- `asyncPaginationSep2025: true` → enables async pagination generators
- `allOfMergeStrategy: shallowMerge` → required for the merged spec

**Merge order matters**: platform.yaml is LAST in the merge command because the last spec's global `servers` win. Platform's servers (EU/US/APAC) are the global default — EU is index 0 (default). All specs live in `oas/`. The server order is set in `prepare_specs.py`.

## Publishing to PyPI

When changes affect the SDK source code (hooks, patches, or regeneration), a new version must be published to PyPI.

### Full publish flow

```bash
# 1. Bump version in BOTH files (must match)
#    - python-sdk/gen.yaml        → python.version
#    - python-sdk/pyproject.toml  → [project].version

# 2. Update PyPI badge cache-buster in README.md
#    [![PyPI](https://img.shields.io/pypi/v/workiva?v=X.Y.Z)]

# 3. Run tests
make test

# 4. Build wheel
make build    # → python-sdk/dist/workiva-X.Y.Z-py3-none-any.whl

# 5. Publish to PyPI
make publish  # runs twine upload (requires TWINE_PASSWORD or ~/.pypirc)

# 6. Create GitHub release
gh release create vX.Y.Z python-sdk/dist/*.whl python-sdk/dist/*.tar.gz \
    --title "vX.Y.Z" --notes "Release notes here"

# 7. Commit, push
```

### What triggers a new version

- Changes to custom hooks (`_hooks/client.py`, `_hooks/polling.py`, `_hooks/exceptions.py`, `_hooks/version_header.py`, `_hooks/registration.py`)
- Changes to `patch_sdk.py` that affect generated output
- Changes to `prepare_specs.py` that affect the generated SDK (tokenUrl, servers, pagination, etc.)
- SDK regeneration after OAS spec updates (`make force`)

### Version files that must stay in sync

| File | Field | Role |
|------|-------|------|
| `python-sdk/gen.yaml` | `python.version` | Controls what Speakeasy writes to pyproject.toml on regeneration |
| `python-sdk/pyproject.toml` | `[project].version` | What `uv build` / `pip` reads |
| `README.md` | Badge `?v=X.Y.Z` | Cache-buster for shields.io |

### PyPI credentials

- **Local**: `~/.pypirc` or `TWINE_PASSWORD` env var
- **CI**: `TWINE_PASSWORD` as GitHub secret (not yet configured)
- **API token**: generate at https://pypi.org/manage/account/token/

## File Survival Matrix

| Location | Survives `make force`? |
|----------|----------------------|
| `oas/`, `gen.yaml`, `scripts/`, `Makefile`, `tests/` | Yes |
| `_hooks/client.py`, `_hooks/polling.py`, `_hooks/exceptions.py`, `_hooks/version_header.py` | Yes (Speakeasy preserves) |
| `_hooks/registration.py` | Yes (generated once) |
| `__init__.py`, `pyproject.toml`, `README.md` | Regenerated, then patched |
| Everything else in `src/workiva/` | Regenerated (do not modify) |
